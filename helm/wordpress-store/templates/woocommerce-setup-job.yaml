{{- if .Values.woocommerce.enabled }}
apiVersion: batch/v1
kind: Job
metadata:
  name: woocommerce-setup
  labels:
    app: {{ .Values.storeName }}
    component: woocommerce-setup
  annotations:
    "helm.sh/hook": post-install
    "helm.sh/hook-weight": "10"
    "helm.sh/hook-delete-policy": hook-succeeded
spec:
  template:
    metadata:
      labels:
        app: {{ .Values.storeName }}
        component: woocommerce-setup
    spec:
      restartPolicy: OnFailure
      initContainers:
      - name: wait-for-wordpress
        image: curlimages/curl:8.5.0
        command:
        - sh
        - -c
        - |
          until curl -f http://wordpress/wp-admin/install.php; do
            echo "Waiting for WordPress..."
            sleep 5
          done
          echo "WordPress is ready!"
      containers:
      - name: install-woocommerce
        image: wordpress:cli-2-php8.2
        command:
        - sh
        - -c
        - |
          # Wait a bit more for WordPress to fully initialize
          sleep 30
          
          # Install WordPress if not already installed
          if ! wp core is-installed --path=/var/www/html --allow-root; then
            wp core install \
              --path=/var/www/html \
              --url=http://{{ .Values.storeName }}.{{ .Values.domain }} \
              --title="{{ .Values.wordpress.siteTitle }}" \
              --admin_user={{ .Values.wordpress.adminUser }} \
              --admin_password=$ADMIN_PASSWORD \
              --admin_email={{ .Values.wordpress.adminEmail }} \
              --allow-root
          fi
          
          # Install and activate WooCommerce
          wp plugin install woocommerce --activate --path=/var/www/html --allow-root || true
          
          # Basic WooCommerce setup
          wp option update woocommerce_store_address "123 Store Street" --path=/var/www/html --allow-root || true
          wp option update woocommerce_store_city "Store City" --path=/var/www/html --allow-root || true
          wp option update woocommerce_default_country "US:CA" --path=/var/www/html --allow-root || true
          wp option update woocommerce_currency "USD" --path=/var/www/html --allow-root || true
          
          # Enable COD payment method
          wp option update woocommerce_cod_settings '{"enabled":"yes","title":"Cash on Delivery"}' --format=json --path=/var/www/html --allow-root || true
          
          # Create a sample product
          wp wc product create \
            --name="Sample Product" \
            --type=simple \
            --regular_price=29.99 \
            --description="This is a sample product" \
            --short_description="Sample product for testing" \
            --manage_stock=1 \
            --stock_quantity=100 \
            --user=1 \
            --path=/var/www/html \
            --allow-root || true
          
          echo "WooCommerce setup completed!"
        env:
        - name: ADMIN_PASSWORD
          valueFrom:
            secretKeyRef:
              name: wordpress-credentials
              key: admin-password
        - name: WORDPRESS_DB_HOST
          value: mysql:3306
        - name: WORDPRESS_DB_NAME
          value: {{ .Values.mysql.database }}
        - name: WORDPRESS_DB_USER
          value: {{ .Values.mysql.user }}
        - name: WORDPRESS_DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mysql-credentials
              key: mysql-password
        volumeMounts:
        - name: wordpress-data
          mountPath: /var/www/html
      volumes:
      - name: wordpress-data
        persistentVolumeClaim:
          claimName: wordpress-pvc
{{- end }}
